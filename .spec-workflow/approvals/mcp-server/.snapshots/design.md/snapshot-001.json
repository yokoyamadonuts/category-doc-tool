{
  "id": "snapshot_1765100371737_qx1ds7nvn",
  "approvalId": "approval_1765100371733_y9pvq8dbz",
  "approvalTitle": "MCP Server Design",
  "version": 1,
  "timestamp": "2025-12-07T09:39:31.737Z",
  "trigger": "initial",
  "status": "pending",
  "content": "# Design Document: MCP Server for CatDoc\n\n## Overview\n\nCatDocの既存CLI機能をModel Context Protocol (MCP)サーバーとして公開する。MCPサーバーはstdioトランスポートを使用し、AIアシスタント（Claude Code、Cursor等）からドキュメント管理・検証機能にアクセスできるようにする。\n\n## Steering Document Alignment\n\n### Technical Standards (tech.md)\n\n- **言語**: TypeScript（既存実装に準拠）\n- **ランタイム**: Bun（既存実装に準拠）\n- **フレームワーク**: @modelcontextprotocol/sdk（公式TypeScript SDK）\n- **スキーマ検証**: Zod（MCP SDKのpeer dependency、既存依存に存在）\n\n### Project Structure (structure.md)\n\nMCPサーバー実装は以下のディレクトリ構造に配置：\n\n```\nsrc/\n├── presentation/\n│   └── mcp/\n│       ├── server.ts          # MCPサーバーエントリーポイント\n│       ├── tools/             # MCPツール定義\n│       │   ├── index.ts       # ツール登録\n│       │   ├── categories.ts  # カテゴリ管理ツール\n│       │   ├── objects.ts     # オブジェクト管理ツール\n│       │   ├── morphisms.ts   # 射管理ツール\n│       │   ├── functors.ts    # 関手ツール\n│       │   ├── validate.ts    # 検証ツール\n│       │   ├── trace.ts       # パス探索ツール\n│       │   ├── search.ts      # 検索ツール\n│       │   └── graph.ts       # グラフデータツール\n│       └── types.ts           # MCP固有の型定義\n```\n\n## Code Reuse Analysis\n\n### Existing Components to Leverage\n\n- **`src/application/cli/validate.ts`**: `validateAll`, `validateCategories`, `validateFunctors`, `validateNaturalTransformations`関数を再利用\n- **`src/application/cli/list.ts`**: `listObjects`, `listMorphisms`, `listCategories`関数を再利用\n- **`src/application/cli/show.ts`**: `showObject`, `showCategory`, `showFunctor`関数を再利用\n- **`src/application/cli/trace.ts`**: `tracePath`, `traceDomainPath`関数を再利用\n- **`src/application/cli/search.ts`**: `searchObjects`関数を再利用\n- **`src/application/cli/init.ts`**: `initProject`関数を再利用\n- **`src/application/cli/import.ts`**: `importDocuments`関数を再利用\n- **`src/application/cli/dashboard.ts`**: `createDashboardServer`関数を再利用\n- **`src/infrastructure/parsers/YamlParser.ts`**: カテゴリ定義の読み込み\n- **`src/domain/services/VerificationService.ts`**: 圏論公理の検証ロジック\n\n### Integration Points\n\n- **既存CLI**: MCPサーバーは既存CLI関数をラップし、JSON形式で結果を返す\n- **ダッシュボード**: `--dashboard`オプションで既存ダッシュボードサーバーを起動\n- **ファイルストレージ**: `.catdoc/category.yaml`からデータを読み込み\n\n## Architecture\n\nMCPサーバーはPresentation層に配置し、既存のApplication層（CLI）をアダプターパターンで呼び出す。\n\n```mermaid\ngraph TD\n    subgraph \"MCP Client\"\n        AI[AI Assistant]\n    end\n\n    subgraph \"Presentation Layer\"\n        MCP[MCP Server<br/>stdio transport]\n        Tools[Tool Handlers]\n    end\n\n    subgraph \"Application Layer\"\n        CLI[CLI Commands]\n        API[REST API Server]\n    end\n\n    subgraph \"Domain Layer\"\n        Verify[VerificationService]\n        Traverse[TraversalService]\n        Compose[CompositionService]\n    end\n\n    subgraph \"Infrastructure Layer\"\n        Parser[YamlParser]\n        Storage[File Storage]\n    end\n\n    AI -->|JSON-RPC over stdio| MCP\n    MCP --> Tools\n    Tools --> CLI\n    MCP -->|optional| API\n    CLI --> Verify\n    CLI --> Traverse\n    CLI --> Compose\n    CLI --> Parser\n    Parser --> Storage\n```\n\n### Modular Design Principles\n\n- **Single File Responsibility**: 各ツールファイルは1つのドメイン（categories, objects等）を担当\n- **Component Isolation**: MCPツールは独立してテスト可能\n- **Service Layer Separation**: MCPツールはCLI関数を呼び出すだけで、ビジネスロジックは持たない\n- **Utility Modularity**: 共通のエラーハンドリング、データ変換は`types.ts`に集約\n\n## Components and Interfaces\n\n### Component 1: MCP Server (`server.ts`)\n\n- **Purpose**: MCPサーバーのエントリーポイント、ツール登録、トランスポート管理\n- **Interfaces**:\n  ```typescript\n  export function createMcpServer(options?: McpServerOptions): McpServer;\n  export function startMcpServer(server: McpServer): Promise<void>;\n  ```\n- **Dependencies**: `@modelcontextprotocol/sdk`, tool handlers\n- **Reuses**: None (new component)\n\n### Component 2: Tool Handlers (`tools/*.ts`)\n\n- **Purpose**: 各MCPツールの実装\n- **Interfaces**:\n  ```typescript\n  // Example: validate.ts\n  export const validateTool: ToolDefinition = {\n    name: \"catdoc_validate\",\n    description: \"Validate all category structures\",\n    inputSchema: z.object({ categoryId: z.string().optional() }),\n    handler: async (params) => ValidateResult\n  };\n  ```\n- **Dependencies**: CLI関数、YamlParser\n- **Reuses**: 既存CLI関数をすべて再利用\n\n### Component 3: CLI Entry Point Extension (`index.ts`)\n\n- **Purpose**: `catdoc mcp`コマンドの追加\n- **Interfaces**:\n  ```typescript\n  program.command(\"mcp\")\n    .option(\"--dashboard\", \"Start dashboard server\")\n    .option(\"--port <port>\", \"Dashboard port\")\n    .action(startMcpCommand);\n  ```\n- **Dependencies**: MCP Server\n- **Reuses**: 既存commanderプログラム\n\n## Data Models\n\n### ToolDefinition\n\n```typescript\ntype ToolDefinition = {\n  name: string;                    // MCPツール名（catdoc_プレフィックス）\n  description: string;             // ツールの説明\n  inputSchema: ZodSchema;          // 入力パラメータスキーマ\n  handler: (params: unknown) => Promise<ToolResult>;\n};\n```\n\n### ToolResult\n\n```typescript\ntype ToolResult = {\n  content: Array<{\n    type: \"text\";\n    text: string;  // JSON文字列化された結果\n  }>;\n  isError?: boolean;\n};\n```\n\n### McpServerOptions\n\n```typescript\ntype McpServerOptions = {\n  projectPath?: string;            // プロジェクトルート（デフォルト: cwd）\n  dashboard?: boolean;             // ダッシュボード起動\n  dashboardPort?: number;          // ダッシュボードポート\n};\n```\n\n## Tool Definitions\n\n| ツール名 | 説明 | 入力パラメータ |\n|---------|------|---------------|\n| `catdoc_init` | プロジェクト初期化 | `directory?: string`, `force?: boolean` |\n| `catdoc_list_categories` | カテゴリ一覧 | `format?: \"json\"` |\n| `catdoc_show_category` | カテゴリ詳細 | `categoryId: string` |\n| `catdoc_list_objects` | オブジェクト一覧 | `domain?: string`, `limit?: number` |\n| `catdoc_show_object` | オブジェクト詳細 | `objectId: string` |\n| `catdoc_import_document` | ドキュメントインポート | `filePath: string`, `domain?: string` |\n| `catdoc_list_morphisms` | 射一覧 | `categoryId?: string` |\n| `catdoc_show_morphism` | 射詳細 | `morphismId: string` |\n| `catdoc_validate` | 全体検証 | `categoryId?: string` |\n| `catdoc_validate_category` | カテゴリ検証 | `categoryId: string` |\n| `catdoc_validate_functor` | 関手検証 | `functorId: string` |\n| `catdoc_validate_natural_transformation` | 自然変換検証 | `id: string` |\n| `catdoc_trace` | パス探索 | `sourceId: string`, `targetId: string`, `findAll?: boolean` |\n| `catdoc_search` | 検索 | `query: string`, `domain?: string`, `limit?: number` |\n| `catdoc_list_functors` | 関手一覧 | なし |\n| `catdoc_show_functor` | 関手詳細 | `functorId: string` |\n| `catdoc_list_natural_transformations` | 自然変換一覧 | なし |\n| `catdoc_show_natural_transformation` | 自然変換詳細 | `id: string` |\n| `catdoc_get_graph` | グラフデータ取得 | `categoryId?: string` |\n\n## Error Handling\n\n### Error Scenarios\n\n1. **プロジェクト未初期化**\n   - **Handling**: `.catdoc/`ディレクトリが存在しない場合、明確なエラーメッセージを返す\n   - **User Impact**: `\"CatDoc project not initialized. Run catdoc_init first.\"`\n\n2. **エンティティが見つからない**\n   - **Handling**: 指定されたID/名前が存在しない場合、`isError: true`で結果を返す\n   - **User Impact**: `\"Category 'xxx' not found\"`\n\n3. **検証エラー**\n   - **Handling**: 検証失敗は正常な結果として返す（`isValid: false`）\n   - **User Impact**: エラー/警告リストを含むJSON\n\n4. **ファイルアクセスエラー**\n   - **Handling**: try-catchでキャッチし、エラーメッセージを返す\n   - **User Impact**: `\"Failed to read category.yaml: [error message]\"`\n\n5. **不正なパラメータ**\n   - **Handling**: Zodスキーマで検証、MCPプロトコルがエラーを返す\n   - **User Impact**: パラメータ検証エラーメッセージ\n\n## Testing Strategy\n\n### Unit Testing\n\n- 各ツールハンドラーの単体テスト\n- モック化したYamlParserを使用\n- エラーケースのテスト（未初期化、エンティティなし等）\n\n```typescript\n// tests/presentation/mcp/tools/validate.test.ts\ndescribe(\"catdoc_validate tool\", () => {\n  it(\"should return isValid: true for valid category\", async () => {\n    // ...\n  });\n\n  it(\"should return errors for invalid category\", async () => {\n    // ...\n  });\n});\n```\n\n### Integration Testing\n\n- MCPサーバー起動→ツール呼び出し→結果検証\n- stdioトランスポートのモック\n\n```typescript\n// tests/presentation/mcp/server.test.ts\ndescribe(\"MCP Server\", () => {\n  it(\"should list all available tools\", async () => {\n    // ...\n  });\n\n  it(\"should execute catdoc_validate tool\", async () => {\n    // ...\n  });\n});\n```\n\n### End-to-End Testing\n\n- 実際のMCPクライアント（テスト用）からの呼び出し\n- ダッシュボード自動起動のテスト\n\n## npm Package Configuration\n\n### package.json Changes\n\n```json\n{\n  \"name\": \"@anthropic/catdoc-mcp\",\n  \"version\": \"0.1.0\",\n  \"bin\": {\n    \"catdoc\": \"./dist/index.js\",\n    \"catdoc-mcp\": \"./dist/mcp.js\"\n  },\n  \"exports\": {\n    \".\": \"./dist/index.js\",\n    \"./mcp\": \"./dist/mcp.js\"\n  },\n  \"files\": [\n    \"dist\",\n    \"README.md\"\n  ],\n  \"dependencies\": {\n    \"@modelcontextprotocol/sdk\": \"^1.24.0\",\n    \"zod\": \"^3.25.0\"\n  }\n}\n```\n\n### MCP設定例（claude_desktop_config.json）\n\n```json\n{\n  \"mcpServers\": {\n    \"catdoc\": {\n      \"command\": \"npx\",\n      \"args\": [\"@anthropic/catdoc-mcp\"],\n      \"env\": {\n        \"CATDOC_PROJECT_PATH\": \"/path/to/project\"\n      }\n    }\n  }\n}\n```\n\n## Implementation Notes\n\n1. **stdio transport**: MCPサーバーはstdioトランスポートを使用。標準入出力でJSON-RPCメッセージを交換\n2. **プロジェクトパス**: 環境変数`CATDOC_PROJECT_PATH`またはcwdをプロジェクトルートとして使用\n3. **ダッシュボード連携**: `--dashboard`オプションでダッシュボードを起動し、URLをstderrに出力\n4. **エラー出力**: MCPプロトコル外のログはstderrに出力（stdoutはMCPメッセージ専用）\n",
  "fileStats": {
    "size": 11198,
    "lines": 326,
    "lastModified": "2025-12-07T09:39:26.088Z"
  },
  "comments": []
}
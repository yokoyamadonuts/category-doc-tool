{
  "id": "snapshot_1763634699014_jxmuhwuj7",
  "approvalId": "approval_1763622895077_5vz3bpfgb",
  "approvalTitle": "Requirements document for CatDoc MVP",
  "version": 2,
  "timestamp": "2025-11-20T10:31:39.014Z",
  "trigger": "revision_requested",
  "status": "pending",
  "content": "# Requirements Document\n\n## Introduction\n\nCategory Documentation Tool (CatDoc) MVP は、異なるドメイン層（業務、仕様、アプリケーション、インフラストラクチャ）のドキュメント間の関係性を圏論（Category Theory）の概念でモデル化し、可視化するツールです。ソフトウェアプロダクト開発チームが、複雑なドキュメント構造の整合性を保ち、変更の影響範囲を追跡できるようにすることを目的とします。\n\nMVPでは、既存のMarkdownドキュメントをインポートし、JSON/YAMLで圏構造を定義し、グラフとして可視化する基本機能を提供します。\n\n## Alignment with Product Vision\n\nこのMVPは、product.mdで定義された以下の目標に沿っています：\n\n- **Object Management**: ドキュメントをオブジェクトとして管理する基盤を構築\n- **Morphism Definition**: ドキュメント間の関係性（射）をJSON/YAMLで定義可能に\n- **Graph Visualization**: React Flowの代わりにSvelteベースの可視化で直感的な理解を実現\n- **Mathematical Rigor**: 圏論の公理（結合律、恒等射）に基づく基本的な検証機能\n\n技術スタックは、よりモダンで軽量な構成（Svelte + Hono + Turso）を採用し、将来の拡張性とパフォーマンスを確保します。\n\n## Requirements\n\n### <a id=\"REQ-DOC-001\"></a>Requirement 1: ドキュメントインポート\n\n**User Story:** As a ソフトウェアアーキテクト, I want 既存のMarkdownドキュメントをシステムにインポートする, so that 既存のドキュメント資産を活用しながら圏論的な管理を始められる\n\n#### Acceptance Criteria\n\n1. WHEN ユーザーが `catdoc import <file-path>` コマンドを実行 THEN システム SHALL Markdownファイルを読み込み、オブジェクトとしてTursoデータベースに保存する\n2. WHEN インポート時にファイルパスが無効 THEN システム SHALL エラーメッセージを表示し、処理を中断する\n3. WHEN インポート時にYAMLフロントマターが存在 THEN システム SHALL メタデータを抽出し、オブジェクトのプロパティとして保存する\n4. WHEN 同一IDのドキュメントが既に存在 THEN システム SHALL 上書き確認プロンプトを表示する\n\n### <a id=\"REQ-DOC-002\"></a>Requirement 2: オブジェクト管理\n\n**User Story:** As a テクニカルライター, I want ドキュメント（オブジェクト）の一覧を表示・検索する, so that システムに登録されているドキュメントを素早く把握できる\n\n#### Acceptance Criteria\n\n1. WHEN ユーザーが `catdoc list` コマンドを実行 THEN システム SHALL すべてのオブジェクトをID、タイトル、ドメインとともに表形式で表示する\n2. WHEN ユーザーが `catdoc show <object-id>` コマンドを実行 THEN システム SHALL 指定されたオブジェクトの詳細（メタデータ、コンテンツ）を表示する\n3. WHEN ユーザーが `catdoc search <keyword>` コマンドを実行 THEN システム SHALL タイトルまたはコンテンツに該当キーワードを含むオブジェクトをリストする\n4. IF オブジェクトが存在しない THEN システム SHALL 適切なメッセージを表示する\n\n### <a id=\"REQ-CAT-001\"></a>Requirement 3: 圏構造定義\n\n**User Story:** As a ソフトウェアアーキテクト, I want オブジェクト間の射（Morphism）をJSON/YAMLで定義する, so that ドキュメント間の依存関係や変換を明示的に管理できる\n\n#### Acceptance Criteria\n\n1. WHEN ユーザーが `.catdoc/category.yaml` ファイルを作成 THEN システム SHALL YAMLファイルから射の定義を読み込む\n2. WHEN YAML内で `morphisms` キーが定義されている AND 各射が `source`, `target`, `name` フィールドを持つ THEN システム SHALL 射をデータベースに保存する\n3. WHEN 射の `source` または `target` が存在しないオブジェクトを参照 THEN システム SHALL 警告を表示し、その射をスキップする\n4. WHEN ユーザーが `catdoc validate` コマンドを実行 THEN システム SHALL 圏の公理（恒等射の存在、合成の結合律）をチェックし、結果を報告する\n\n### <a id=\"REQ-CAT-002\"></a>Requirement 4: 圏論的検証\n\n**User Story:** As a 開発チームリーダー, I want 定義された圏構造が圏論の公理を満たすか検証する, so that ドキュメント間の関係性の整合性を数学的に保証できる\n\n#### Acceptance Criteria\n\n1. WHEN `catdoc validate` コマンドが実行される THEN システム SHALL すべてのオブジェクトに対して恒等射（identity morphism）が存在するか確認する\n2. WHEN 射 f: A→B と g: B→C が存在する THEN システム SHALL 合成射 g∘f: A→C が定義されているか、または自動的に推論可能かチェックする\n3. WHEN 射 f: A→B, g: B→C, h: C→D が存在する THEN システム SHALL (h∘g)∘f = h∘(g∘f) の結合律が成立するか検証する\n4. WHEN 検証に失敗 THEN システム SHALL 違反箇所を具体的に（オブジェクトID、射名）レポートする\n\n### <a id=\"REQ-VIS-001\"></a>Requirement 5: グラフ可視化（Webダッシュボード）\n\n**User Story:** As a ソフトウェアアーキテクト, I want ドキュメントの圏構造をインタラクティブなグラフで表示する, so that 複雑な関係性を視覚的に理解し、探索できる\n\n#### Acceptance Criteria\n\n1. WHEN ユーザーが `catdoc dashboard` コマンドを実行 THEN システム SHALL Honoサーバーを起動し、Svelteベースのダッシュボードを表示する\n2. WHEN ダッシュボードが読み込まれる THEN システム SHALL すべてのオブジェクト（ノード）と射（エッジ）をグラフ形式で表示する\n3. WHEN ユーザーがノードをクリック THEN システム SHALL そのオブジェクトの詳細情報（タイトル、ドメイン、メタデータ）をサイドパネルに表示する\n4. WHEN ユーザーがエッジをクリック THEN システム SHALL その射の名前、source、targetを表示する\n5. WHEN グラフに100ノード以上が含まれる THEN システム SHALL 5秒以内にレンダリングを完了する\n\n### <a id=\"REQ-VIS-002\"></a>Requirement 6: グラフインタラクション\n\n**User Story:** As a テクニカルライター, I want グラフ上でノードをドラッグして配置を調整する, so that 視覚的に分かりやすいレイアウトを作成できる\n\n#### Acceptance Criteria\n\n1. WHEN ユーザーがノードをドラッグ THEN システム SHALL ノードの位置をリアルタイムで更新する\n2. WHEN ユーザーがグラフをズーム/パン THEN システム SHALL スムーズに表示範囲を調整する\n3. WHEN ユーザーが「レイアウト自動調整」ボタンをクリック THEN システム SHALL 階層的レイアウトアルゴリズムでノードを再配置する\n4. WHEN ユーザーがノードを選択 AND 関連する射を強調表示 THEN システム SHALL 選択ノードに接続するエッジを太線または色付きで表示する\n\n### <a id=\"REQ-SYS-001\"></a>Requirement 7: データ永続化\n\n**User Story:** As a システム管理者, I want すべてのオブジェクトと射をTursoデータベースに永続化する, so that データの一貫性と高速なクエリを実現できる\n\n#### Acceptance Criteria\n\n1. WHEN オブジェクトまたは射が作成/更新される THEN システム SHALL Tursoデータベースにトランザクションとして保存する\n2. WHEN システムが起動される THEN システム SHALL Tursoから既存のデータを読み込み、メモリキャッシュを構築する\n3. WHEN データベース接続に失敗 THEN システム SHALL エラーメッセージを表示し、適切にフォールバックする（例：読み取り専用モード）\n4. WHEN 同時書き込みが発生 THEN システム SHALL トランザクション分離レベルを保ち、データの整合性を維持する\n\n### <a id=\"REQ-SYS-002\"></a>Requirement 8: CLI初期化\n\n**User Story:** As a 新規ユーザー, I want `catdoc init` コマンドでプロジェクトを初期化する, so that 必要な設定ファイルとデータベースを自動生成できる\n\n#### Acceptance Criteria\n\n1. WHEN ユーザーが `catdoc init` コマンドを実行 THEN システム SHALL `.catdoc/` ディレクトリを作成する\n2. WHEN 初期化が実行される THEN システム SHALL `.catdoc/category.yaml` テンプレートファイルを生成する\n3. WHEN 初期化が実行される THEN システム SHALL Tursoデータベース接続を設定し、必要なテーブル（objects, morphisms）を作成する\n4. WHEN `.catdoc/` が既に存在 THEN システム SHALL 上書き確認プロンプトを表示する\n\n## Non-Functional Requirements\n\n### Code Architecture and Modularity\n\n- **Single Responsibility Principle**: 各モジュールは単一の責務を持つ\n  - `src/domain/`: 圏論のドメインロジック（Object, Morphism, Category, Verification）\n  - `src/infrastructure/`: データベース接続、ファイルIO\n  - `src/application/`: CLIコマンド、APIエンドポイント\n  - `src/presentation/`: Svelteコンポーネント\n- **Modular Design**: Honoのミドルウェア、Svelteコンポーネント、ドメインロジックを独立したモジュールとして設計\n- **Dependency Management**: ドメインロジックは外部依存を持たない（Clean Architecture）\n- **Clear Interfaces**: Repository patternでデータアクセスを抽象化\n\n### Performance\n\n- **起動時間**: `catdoc` コマンドは1秒以内に起動\n- **インポート速度**: 100KBのMarkdownファイルを100ms以内に処理\n- **検証速度**: 1000ノード、5000エッジのグラフを1秒以内に検証\n- **ダッシュボード応答**: APIエンドポイントは100ms以内にレスポンス（P95）\n- **グラフレンダリング**: 100ノードを5秒以内、1000ノードを30秒以内に描画\n\n### Security\n\n- **入力検証**: すべてのユーザー入力（ファイルパス、YAML、コマンド引数）をサニタイズ\n- **SQLインジェクション対策**: Turso接続でプリペアドステートメントを使用\n- **XSS対策**: Svelteの自動エスケープを活用し、Markdown表示時はサニタイズライブラリを使用\n- **ローカルアクセス**: ダッシュボードは `127.0.0.1` のみでバインド\n- **認証**: MVPでは不要（ローカル実行のみ）\n\n### Reliability\n\n- **エラーハンドリング**: すべての外部I/O（ファイル、DB）で適切なエラーハンドリングを実装\n- **データ整合性**: トランザクションを使用してデータベース操作の原子性を保証\n- **フォールバック**: データベース接続失敗時は適切なエラーメッセージを表示\n- **ログ**: 重要な操作（インポート、検証、サーバー起動）をログに記録\n\n### Usability\n\n- **CLIフィードバック**: すべてのコマンドは進捗状況を表示（スピナー、プログレスバー）\n- **エラーメッセージ**: 具体的で実行可能な改善提案を含む（例：「オブジェクト 'X' が見つかりません。`catdoc list` で確認してください」）\n- **ドキュメント**: README.mdに基本的な使い方、examples/に実践的なサンプルを含める\n- **ヘルプコマンド**: `catdoc --help`, `catdoc <command> --help` で詳細なヘルプを表示\n- **UI/UX**: ダッシュボードは直感的で、グラフ操作に説明ツールチップを表示\n",
  "fileStats": {
    "size": 11995,
    "lines": 154,
    "lastModified": "2025-11-20T07:13:36.496Z"
  },
  "comments": []
}